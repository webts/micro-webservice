{"version":3,"sources":["../../lib/core/DbClient.js"],"names":["DbClient","constructor","opts","transactionOpts","options","transactionOptions","client","getConnectionUri","url","username","password","host","port","dbName","authSource","find","query","getById","id","database","begin","MongoClient","connect","emit","end","close"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA;;;;AAIe,MAAMA,QAAN,8BACf;AACIC,cAAYC,IAAZ,EAAkBC,eAAlB,EAAkC;AAC9B;AACA,SAAKC,OAAL,GAAeF,IAAf;AACA,SAAKG,kBAAL,GAA0BF,mBAAmB,EAA7C;AACA,SAAKG,MAAL,GAAc,IAAd;AAEH;AAED;;;;;;AAIAC,qBAAkB;AACd,QAAIC,MAAO,aAAY,KAAKJ,OAAL,CAAaK,QAAS,IAAG,KAAKL,OAAL,CAAaM,QAAS,IAAG,KAAKN,OAAL,CAAaO,IAAK,IAAI,KAAKP,OAAL,CAAaQ,IAAb,IAAqB,KAAM,IAAG,KAAKC,MAAO,EAAzI;;AACA,QAAG,KAAKT,OAAL,CAAaU,UAAhB,EAA2B;AACvBN,aAAQ,eAAc,KAAKJ,OAAL,CAAaU,UAAW,EAA9C;AACH;;AAED,WAAON,GAAP;AACH;;AAED,QAAMO,IAAN,CAAWC,KAAX,EAAiB;AACb,QAAG,KAAKV,MAAR,EAAe;AACX,aAAO,MAAM,KAAKA,MAAL,CAAYS,IAAZ,CAAiBC,KAAjB,CAAb;AACH;;AAED,WAAO,IAAP;AACH;;AAED,QAAMC,OAAN,CAAcC,EAAd,EAAiB;AACb,QAAG,KAAKZ,MAAR,EAAe;AACX,aAAO,MAAO,KAAKA,MAAL,CAAYS,IAAZ,CAAiB;AAACG;AAAD,OAAjB,CAAd;AACH;;AAED,WAAO,IAAP;AACH;;AAEDC,WAASN,MAAT,EAAgB;AACZ,SAAKA,MAAL,GAAcA,MAAd;AAEA,WAAO,IAAP;AACH;AAED;;;;;;;AAKA,QAAMO,KAAN,GAAa;AACT,SAAKd,MAAL,GAAc,MAAM,iBAAMe,WAAN,CAAkBC,OAAlB,CAA0B,KAAKf,gBAAL,EAA1B,CAApB;AACA,SAAKgB,IAAL,CAAU,eAAV,EAA2B,qBAAqB,KAAKhB,gBAAL,EAAhD;AAEA,WAAO,IAAP;AACH;AAED;;;;;;;AAKA,QAAMiB,GAAN,GAAW;AACP,UAAM,KAAKlB,MAAL,CAAYmB,KAAZ,EAAN;AAEA,SAAKF,IAAL,CAAU,gBAAV,EAA4B,uBAAuB,KAAKhB,gBAAL,EAAnD;AACH;;AAjEL","file":"DbClient.js","sourcesContent":["import mongo from 'mongodb';\r\nimport {EventEmitter} from 'events';\r\n\r\n/**\r\n * DB abstraction layer with partial transaction support for\r\n * mongodb\r\n */\r\nexport default class DbClient extends EventEmitter\r\n{\r\n    constructor(opts, transactionOpts){\r\n        super();\r\n        this.options = opts;\r\n        this.transactionOptions = transactionOpts || {};\r\n        this.client = null;\r\n\r\n    }\r\n\r\n    /**\r\n     * return connection string\r\n     * @return {string}\r\n     */\r\n    getConnectionUri(){\r\n        let url = `mongodb://${this.options.username}:${this.options.password}@${this.options.host}:${ this.options.port || 27301}/${this.dbName}`;\r\n        if(this.options.authSource){\r\n            url += `?authSource=${this.options.authSource}`;\r\n        }\r\n\r\n        return url;\r\n    }\r\n\r\n    async find(query){\r\n        if(this.client){\r\n            return await this.client.find(query);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    async getById(id){\r\n        if(this.client){\r\n            return await  this.client.find({id});\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    database(dbName){\r\n        this.dbName = dbName;\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * begin a transaction\r\n     * this will open a connection to db\r\n     * @return {Promise.<DbClient>}\r\n     */\r\n    async begin(){\r\n        this.client = await mongo.MongoClient.connect(this.getConnectionUri());\r\n        this.emit(\"DbClient:Open\", \"Open connection \" + this.getConnectionUri());\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param client {mongo.MongoClient}\r\n     * @return {Promise.<void>}\r\n     */\r\n    async end(){\r\n        await this.client.close();\r\n\r\n        this.emit(\"DbClient:Close\", \"Closed connection \" + this.getConnectionUri());\r\n    }\r\n}"]}