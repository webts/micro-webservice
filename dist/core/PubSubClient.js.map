{"version":3,"sources":["../../lib/core/PubSubClient.js"],"names":["PubSubClient","constructor","opts","url","host","port","options","topics","log","getLogger","bind","logging","client","mqtt","connect","send","topic","payload","JSON","stringify","publish","end","subscribe","callback","isConnected","Error","destroy","Object","keys","forEach","unsubscribe","err","level","message","stack","meta","from","onConnect","cb","call","connectedCallback","on","_connected","onMessage","msg"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;;;AAEe,MAAMA,YAAN,CAAmB;AAC9BC,cAAYC,IAAZ,EAAkB;AAGd,QAAG,EAAE,SAASA,IAAX,CAAH,EAAoB;AAChBA,WAAKC,GAAL,GAAW,YAAYD,KAAKE,IAAjB,IAAyBF,KAAKG,IAAL,GAAYH,KAAKG,IAAjB,GAAuB,EAAhD,CAAX;AACH;AAED;;;;;AAGA,SAAKC,OAAL,GAAeJ,IAAf;AACA;;;;;AAIA,SAAKK,MAAL,GAAc,EAAd;AACA;;;;AAGA,SAAKC,GAAL,GAAcC,gBAAUC,IAAV,CAAe;AAACJ,eAAS,KAAKA,OAAL,CAAaK;AAAvB,KAAf,EAAgD,QAAhD,CAAd;AAEA;;;;;AAIA,SAAKC,MAAL,GAAcC,mBAAKC,OAAL,CAAaZ,KAAKC,GAAlB,EAAuBD,KAAKI,OAA5B,CAAd;AACH;;AAED,QAAMS,IAAN,CAAWC,KAAX,EAAkBC,OAAlB,EAA2B;AACvB,QAAG,OAAOA,OAAP,KAAmB,QAAtB,EACIA,UAAUC,KAAKC,SAAL,CAAeF,OAAf,CAAV;AAEJ,UAAM,KAAKL,MAAL,CAAYQ,OAAZ,CAAoBJ,KAApB,EAA2BC,OAA3B,CAAN;AACA,WAAO,KAAKL,MAAL,CAAYS,GAAZ,EAAP;AACH;;AAEDC,YAAUN,KAAV,EAAiBO,QAAjB,EAA2B;AACvB,QAAIP,SAAS,KAAKT,MAAlB,EACI,OAAO,IAAP;AAEJ,SAAKA,MAAL,CAAYS,KAAZ,IAAqBO,QAArB;AACA,QAAG,KAAKC,WAAR,EACI,KAAKZ,MAAL,CAAYU,SAAZ,CAAsBN,KAAtB;AAEJ,UAAM,IAAIS,KAAJ,CAAU,2BAAV,CAAN;AACH;;AAED,QAAMC,OAAN,GAAgB;AACZ;AACAC,WAAOC,IAAP,CAAY,KAAKrB,MAAjB,EAAyBsB,OAAzB,CAAiC,MAAOb,KAAP,IAAiB;AAC9C,UAAI;AACA,cAAM,KAAKJ,MAAL,CAAYkB,WAAZ,CAAwBd,KAAxB,CAAN;AACH,OAFD,CAGA,OAAOe,GAAP,EAAY;AACR,aAAKvB,GAAL,CAASA,GAAT,CAAa;AACTwB,iBAAM,OADG;AAETC,mBAASF,IAAIG,KAAJ,IAAaH,IAAIE,OAFjB;AAGTE,gBAAK;AAACC,kBAAM;AAAP;AAHI,SAAb;AAKH;AACJ,KAXD;AAaA,WAAO,KAAK7B,MAAZ;AACH;;AAED8B,YAAUC,EAAV,EAAa;AACT,QAAG,KAAKd,WAAR,EACIc,GAAGC,IAAH,CAAQ,IAAR,EADJ,KAEK;AACD;;;AAGA,WAAKC,iBAAL,GAAyBF,EAAzB;AAEA,WAAK1B,MAAL,CAAY6B,EAAZ,CAAe,SAAf,EAA0B,KAAKC,UAA/B;AACH;AACJ;;AAEDC,YAAU3B,KAAV,EAAiB4B,GAAjB,EAAqB;AACjB,QAAIN,KAAK,KAAK/B,MAAL,CAAYS,KAAZ,CAAT;;AACA,QAAGsB,OAAO,IAAP,IAAe,OAAOA,EAAP,KAAc,UAAhC,EAA2C;AACvCA,SAAGC,IAAH,CAAQ,IAAR,EAAcK,GAAd;AACH;AACJ;;AAEDF,eAAY;AACR,SAAKlB,WAAL,GAAmB,IAAnB;;AACA,QAAG,KAAKgB,iBAAL,IAA0B,OAAO,KAAKA,iBAAZ,KAAkC,UAA/D,EAA0E;AACtE,WAAKA,iBAAL,CAAuBD,IAAvB,CAA4B,IAA5B;AACA,aAAO,KAAKC,iBAAZ;AACH;AACJ;;AA5F6B","sourcesContent":["import mqtt from 'async-mqtt';\r\nimport {MqttClient} from 'mqtt';\r\nimport getLogger from './logger';\r\n\r\nexport default class PubSubClient {\r\n    constructor(opts) {\r\n\r\n        \r\n        if(!('url' in opts)){\r\n            opts.url = 'mqtt://' + opts.host + (opts.port ? opts.port :'');\r\n        }\r\n\r\n        /**\r\n         * @private\r\n         */\r\n        this.options = opts;\r\n        /**\r\n         * @private\r\n         * @type {{}}\r\n         */\r\n        this.topics = {};\r\n        /**\r\n         * @private\r\n         */\r\n        this.log    = getLogger.bind({options: this.options.logging})('pubsub');\r\n\r\n        /**\r\n         * @private\r\n         * @class {MqttClient}\r\n         */\r\n        this.client = mqtt.connect(opts.url, opts.options);\r\n    }\r\n\r\n    async send(topic, payload) {\r\n        if(typeof payload === 'object')\r\n            payload = JSON.stringify(payload);\r\n\r\n        await this.client.publish(topic, payload);\r\n        return this.client.end();\r\n    }\r\n\r\n    subscribe(topic, callback) {\r\n        if (topic in this.topics)\r\n            return true;\r\n\r\n        this.topics[topic] = callback;\r\n        if(this.isConnected)\r\n            this.client.subscribe(topic);\r\n\r\n        throw new Error(\"PubSubClient is not ready\");\r\n    }\r\n\r\n    async destroy() {\r\n        //unsubscribe all topics\r\n        Object.keys(this.topics).forEach(async (topic) => {\r\n            try {\r\n                await this.client.unsubscribe(topic)\r\n            }\r\n            catch (err) {\r\n                this.log.log({\r\n                    level:'error',\r\n                    message: err.stack || err.message,\r\n                    meta:{from: 'PubSubClient'}\r\n                })\r\n            }\r\n        });\r\n\r\n        delete this.topics;\r\n    }\r\n\r\n    onConnect(cb){\r\n        if(this.isConnected)\r\n            cb.call(null);\r\n        else {\r\n            /**\r\n             * @private\r\n             */\r\n            this.connectedCallback = cb;\r\n\r\n            this.client.on('connect', this._connected);\r\n        }\r\n    }\r\n\r\n    onMessage(topic, msg){\r\n        let cb = this.topics[topic];\r\n        if(cb !== null && typeof cb === 'function'){\r\n            cb.call(null, msg);\r\n        }\r\n    }\r\n\r\n    _connected(){\r\n        this.isConnected = true;\r\n        if(this.connectedCallback && typeof this.connectedCallback === 'function'){\r\n            this.connectedCallback.call(null);\r\n            delete this.connectedCallback;\r\n        }\r\n    }\r\n}"],"file":"PubSubClient.js"}