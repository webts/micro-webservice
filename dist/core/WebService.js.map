{"version":3,"sources":["../../lib/core/WebService.js"],"names":["getParams","func","str","toString","len","indexOf","substr","replace","split","WebService","constructor","opts","options","name","container_name","cwd","root","server","router","Router","port","db","getDb","session","pubsub","messageBus","authenticator","logger","bind","logging","srcs","Array","isArray","deps","prototype","push","apply","src","register","then","log","level","message","defaults","use","filePattern","base","patterns","map","file","resolve","plugins","realpath","expandDirectories","length","forEach","fn","require","attrs","attributes","uri","startsWith","method","authen","app","all","wrapFn","req","res","next","params","vals","p","param","domain","hostname","fnVal","user","json","err","status","send","call","start","listen","JSON","stringify","service","path","process","on","stop","authenticate","tokenUtil","opKind","data","Promise","reject","Error","obj","isObject","msg"],"mappings":"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","file":"WebService.js","sourcesContent":["import util from 'util';\r\nimport express from 'express';\r\nimport cors from 'cors';\r\nimport globby from 'globby';\r\nimport path from 'path';\r\n\r\nimport logger from './logger';\r\nimport Session from './Session';\r\nimport DbClient from './DbClient';\r\nimport PubSubClient from './PubSubClient';\r\nimport Authenticator from \"./Authenticator\";\r\n\r\nfunction getParams(func) {\r\n    let str = func.toString();\r\n    const len = str.indexOf(\"(\");\r\n    return str.substr(len + 1, str.indexOf(\")\") - len - 1).replace(/ /g, \"\").split(',')\r\n}\r\n\r\nexport default class WebService {\r\n    constructor(opts) {\r\n        this.options = opts;\r\n        this.name = opts.name || opts.container_name;\r\n        this.cwd = opts.root;\r\n\r\n        /**\r\n         *\r\n         * @type {*|express}\r\n         */\r\n        this.server = express();\r\n        this.router = express.Router();\r\n\r\n        this.port = opts.port || 3000;\r\n\r\n\r\n        if (typeof opts.db !== 'undefined') {\r\n            this.getDb = () => {\r\n                return new DbClient(this.options.db);\r\n            }\r\n        }\r\n\r\n        if (typeof opts.session !== 'undefined') {\r\n            this.session = new Session(this.options.session);\r\n        }\r\n\r\n        this.pubsub = new PubSubClient(this.options.messageBus);\r\n        this.authenticator = new Authenticator(this);\r\n        this.logger = logger.bind({options:this.options.logging})(this.name);\r\n\r\n        let srcs = [];\r\n        if ('deps' in this.options) {\r\n            if (Array.isArray(this.options.deps)) {\r\n                Array.prototype.push.apply(srcs, this.options.deps);\r\n            }\r\n            else {\r\n                srcs.push(this.options.deps);\r\n            }\r\n        }\r\n        if ('src' in this.options) {\r\n            if (Array.isArray(this.options.src)) {\r\n                Array.prototype.push.apply(srcs, this.options.src);\r\n            }\r\n            else {\r\n                srcs.push(this.options.src);\r\n            }\r\n        }\r\n\r\n        this.register(srcs).then(() => this.log({level:'info', message:'Plugins registered'}));\r\n\r\n        this.defaults();\r\n\r\n        this.server.use(this.router);\r\n    }\r\n\r\n    async register(filePattern) {\r\n        const base = this;\r\n        this.log('cwd ' + this.cwd)\r\n        let patterns = [filePattern];\r\n        if(Array.isArray(filePattern)) patterns = filePattern;\r\n        patterns = patterns.map((file) => path.resolve(this.cwd, file));\r\n        try {\r\n            const plugins = await globby(patterns, {realpath: true, expandDirectories:true});\r\n            if (plugins && plugins.length > 0)\r\n            {\r\n                plugins.forEach((file) =>\r\n                {\r\n                    this.log('service registers ' + file);\r\n                    let fn = require(file);\r\n                    if (typeof fn === 'function')\r\n                    {\r\n                        if ('attributes' in fn)\r\n                        {\r\n                            const attrs = fn.attributes;\r\n                            if ('uri' in attrs) {\r\n                                let uri = '';\r\n\r\n                                if(attrs.uri.startsWith('/'))\r\n                                    uri = attrs.uri;\r\n                                else\r\n                                    uri = `/api/${this.name}/${attrs.uri}`;\r\n                                if ('nowrap' in attrs) {\r\n                                    if ('method' in attrs) {\r\n                                        const method = attrs.method;\r\n                                        this.router[method](uri, this.authen(), fn.bind({app: base}));\r\n                                    }\r\n                                    else\r\n                                        this.router.all(uri, this.authen(), fn.bind({app: base}));\r\n                                }\r\n                                else\r\n                                {\r\n                                    let wrapFn = async (req, res, next) =>\r\n                                    {\r\n                                        const params = getParams(fn);\r\n                                        let vals = params.map((p) => {return req.param(p)});\r\n                                        const domain = req.hostname.split('.').length > 1 ? req.hostname.split('.')[0]: '';\r\n                                        try {\r\n                                            const fnVal = await fn.apply({app: base, user: req.user, domain:domain, next:next}, vals);\r\n\r\n                                            //TODO: currently support only json render\r\n                                            res.json(fnVal);\r\n                                        }\r\n                                        catch(err){\r\n                                            this.log({\r\n                                                level:'error',\r\n                                                message: err.message\r\n                                            });\r\n                                            res.status(404).send(err.message);\r\n                                        }\r\n                                    };\r\n\r\n                                    if ('method' in attrs) {\r\n                                        const method = attrs.method;\r\n                                        this.router[method](uri, this.authen(), wrapFn);\r\n                                    }\r\n                                    else\r\n                                        this.router.all(uri, this.authen(), wrapFn);\r\n                                }\r\n                            }\r\n                        }\r\n                        else {\r\n                            fn.call(null, this);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n        catch (err) {\r\n            this.log({\r\n                level: 'error',\r\n                message: err.message\r\n            })\r\n        }\r\n    }\r\n\r\n    start()\r\n    {\r\n        this.log({\r\n            level:'info',\r\n            message: `service ${this.name} listening at port ${this.port}`\r\n        });\r\n        this.server.listen(this.port);\r\n        //notify the proxy registry\r\n        this.pubsub.send('#service', JSON.stringify({\r\n            service: this.name,\r\n            port: this.port,\r\n            path: this.name\r\n        }) );\r\n\r\n        //set hook on process kill signal\r\n        this.status = 'running';\r\n        process.on('SIGINT', this.stop);\r\n        process.on('SIGTERM', this.stop);\r\n    }\r\n\r\n    stop()\r\n    {\r\n        if(this.status === 'running') {\r\n            //clean up\r\n            this.log({\r\n                level: 'info',\r\n                message: `service ${this.name} listening at port ${this.port}`\r\n            });\r\n\r\n            this.pubsub.send('#service', JSON.stringify({\r\n                service: this.name,\r\n                port: this.port,\r\n                path: this.name\r\n            }));\r\n        }\r\n    }\r\n\r\n    defaults() {\r\n        this.server.use(express.json());\r\n        this.server.use(cors());\r\n        this.server.use(logger.bind({options:this.options.logging})(this.name,'express'));\r\n    }\r\n\r\n    /**\r\n     * this will be overwrite by Authenticator\r\n     */\r\n    authen() {\r\n        return this.authenticator.authenticate;\r\n    }\r\n\r\n    tokenUtil(opKind, data)\r\n    {\r\n        Promise.reject(new Error('tokenUtil is not implemented'));\r\n    }\r\n\r\n    log(obj){\r\n        let level = 'info';\r\n        if(util.isObject(obj) && 'level' in obj)\r\n            level = obj.level;\r\n\r\n        let msg = '';\r\n\r\n        if(util.isObject(obj) && 'message' in obj)\r\n            msg = obj.message;\r\n        else\r\n            msg = obj;\r\n\r\n        if(level in this.logger)\r\n        {\r\n            this.logger[level](msg);\r\n        }\r\n    }\r\n\r\n}"]}